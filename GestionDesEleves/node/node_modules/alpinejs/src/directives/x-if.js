import { evaluateLater } from 'alpinejs/src/evaluator'
import { addScopeToNode } from 'alpinejs/src/scope'
import { directive } from 'alpinejs/src/directives'
import { initTree } from 'alpinejs/src/lifecycle'
import { mutateDom } from 'alpinejs/src/mutation'
import { walk } from "alpinejs/src/utils/walk"
import { dequeueJob } from 'alpinejs/src/scheduler'
import { warn } from "alpinejs/src/utils/warn"

directive('if', (el, { expression }, { effect, cleanup }) => {
    if (el.tagName.toLowerCase() !== 'template') warn('x-if can only be used on a <template> tag', el)

    let evaluate = evaluateLater(el, expression)

    let show = () => {
        if (el._x_currentIfEl) return el._x_currentIfEl

        let clone = el.content.cloneNode(true).firstElementChild

        addScopeToNode(clone, {}, el)

        mutateDom(() => {
            el.after(clone)

            initTree(clone)
        })

        el._x_currentIfEl = clone

        el._x_undoIf = () => {
            walk(clone, (node) => {
                if (!!node._x_effects) {
                    node._x_effects.forEach(dequeueJob)
                }
            })
            
            clone.remove();

            delete el._x_currentIfEl
        }

        return clone
    }

    let hide = () => {
        if (! el._x_undoIf) return

        el._x_undoIf()

        delete el._x_undoIf
    }

    effect(() => evaluate(value => {
        value ? show() : hide()
    }))

    cleanup(() => el._x_undoIf && el._x_undoIf())
})
